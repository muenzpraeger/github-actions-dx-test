!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ObservableMembrane=t()}(this,function(){"use strict";const{isArray:e}=Array,{getPrototypeOf:t,create:r,defineProperty:n,defineProperties:a,isExtensible:s,getOwnPropertyDescriptor:o,getOwnPropertyNames:i,getOwnPropertySymbols:u,preventExtensions:l,hasOwnProperty:c}=Object,{push:v,concat:g,map:b}=Array.prototype;function f(e){return void 0===e}function h(e){return"function"==typeof e}const y=new WeakMap;function p(e,t){y.set(e,t)}const d=e=>y.get(e)||e;function O(e,t){return e.valueIsObservable(t)?e.getProxy(t):t}function m(e,t,r){g.call(i(r),u(r)).forEach(a=>{let s=o(r,a);s.configurable||(s=R(e,s,O)),n(t,a,s)}),l(t)}class P{constructor(e,t){this.originalTarget=t,this.membrane=e}get(e,t){const{originalTarget:r,membrane:n}=this,a=r[t],{valueObserved:s}=n;return s(r,t),n.getProxy(a)}set(t,r,n){const{originalTarget:a,membrane:{valueMutated:s}}=this;return a[r]!==n?(a[r]=n,s(a,r)):"length"===r&&e(a)&&s(a,r),!0}deleteProperty(e,t){const{originalTarget:r,membrane:{valueMutated:n}}=this;return delete r[t],n(r,t),!0}apply(e,t,r){}construct(e,t,r){}has(e,t){const{originalTarget:r,membrane:{valueObserved:n}}=this;return n(r,t),t in r}ownKeys(e){const{originalTarget:t}=this;return g.call(i(t),u(t))}isExtensible(e){const t=s(e);if(!t)return t;const{originalTarget:r,membrane:n}=this,a=s(r);return a||m(n,e,r),a}setPrototypeOf(e,t){}getPrototypeOf(e){const{originalTarget:r}=this;return t(r)}getOwnPropertyDescriptor(e,t){const{originalTarget:r,membrane:a}=this,{valueObserved:s}=this.membrane;s(r,t);let i=o(r,t);if(f(i))return i;const u=o(e,t);return f(u)?((i=R(a,i,O)).configurable||n(e,t,i),i):u}preventExtensions(e){const{originalTarget:t,membrane:r}=this;return m(r,e,t),l(t),!0}defineProperty(e,t,r){const{originalTarget:a,membrane:s}=this,{valueMutated:i}=s,{configurable:u}=r;if(c.call(r,"writable")&&!c.call(r,"value")){const e=o(a,t);r.value=e.value}return n(a,t,function(e){return c.call(e,"value")&&(e.value=d(e.value)),e}(r)),!1===u&&n(e,t,R(s,r,O)),i(a,t),!0}}function w(e,t){return e.valueIsObservable(t)?e.getReadOnlyProxy(t):t}class x{constructor(e,t){this.originalTarget=t,this.membrane=e}get(e,t){const{membrane:r,originalTarget:n}=this,a=n[t],{valueObserved:s}=r;return s(n,t),r.getReadOnlyProxy(a)}set(e,t,r){return!1}deleteProperty(e,t){return!1}apply(e,t,r){}construct(e,t,r){}has(e,t){const{originalTarget:r,membrane:{valueObserved:n}}=this;return n(r,t),t in r}ownKeys(e){const{originalTarget:t}=this;return g.call(i(t),u(t))}setPrototypeOf(e,t){}getOwnPropertyDescriptor(e,t){const{originalTarget:r,membrane:a}=this,{valueObserved:s}=a;s(r,t);let i=o(r,t);if(f(i))return i;const u=o(e,t);return f(u)?(i=R(a,i,w),c.call(i,"set")&&(i.set=void 0),i.configurable||n(e,t,i),i):u}preventExtensions(e){return!1}defineProperty(e,t,r){return!1}}function T(t){let r=void 0;return e(t)?r=[]:"object"==typeof t&&(r={}),r}const M=Object.prototype;function D(r){if(null===r)return!1;if("object"!=typeof r)return!1;if(e(r))return!0;const n=t(r);return n===M||null===n||null===t(n)}const j=(e,t)=>{},I=(e,t)=>{},E=e=>e;function R(e,t,r){const{set:n,get:a}=t;return c.call(t,"value")?t.value=r(e,t.value):(f(a)||(t.get=function(){return r(e,a.call(d(this)))}),f(n)||(t.set=function(t){n.call(d(this),e.unwrapProxy(t))})),t}return class{constructor(e){if(this.valueDistortion=E,this.valueMutated=I,this.valueObserved=j,this.valueIsObservable=D,this.objectGraph=new WeakMap,!f(e)){const{valueDistortion:t,valueMutated:r,valueObserved:n,valueIsObservable:a}=e;this.valueDistortion=h(t)?t:E,this.valueMutated=h(r)?r:I,this.valueObserved=h(n)?n:j,this.valueIsObservable=h(a)?a:D}}getProxy(e){const t=d(e),r=this.valueDistortion(t);if(this.valueIsObservable(r)){const n=this.getReactiveState(t,r);return n.readOnly===e?e:n.reactive}return r}getReadOnlyProxy(e){e=d(e);const t=this.valueDistortion(e);return this.valueIsObservable(t)?this.getReactiveState(e,t).readOnly:t}unwrapProxy(e){return d(e)}getReactiveState(e,t){const{objectGraph:r}=this;let a=r.get(t);if(a)return a;const s=this;return a={get reactive(){const r=new P(s,t),a=new Proxy(T(t),r);return p(a,e),n(this,"reactive",{value:a}),a},get readOnly(){const r=new x(s,t),a=new Proxy(T(t),r);return p(a,e),n(this,"readOnly",{value:a}),a}},r.set(t,a),a}}});
